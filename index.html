<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLMà½¢à½²à½‚à¼‹à½“à½´à½¦</title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ä½¿ç”¨ Inter å­—ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* ç¡®ä¿ body è¦†ç›–æ•´ä¸ªè§†å£é«˜åº¦ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* ç»Ÿä¸€çš„æµ…ç°è‰²èƒŒæ™¯ */
            height: 100vh; /* å¼ºåˆ¶å æ®æ•´ä¸ªè§†å£é«˜åº¦ */
        }
        
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™æ»šåŠ¨åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* è‡ªå®šä¹‰åŠ è½½æŒ‡ç¤ºå™¨ */
        .loading-dots div {
            width: 8px;
            height: 8px;
            background-color: #3b82f6;
            border-radius: 50%;
            margin: 0 4px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dots div:nth-child(1) { animation-delay: -0.32s; }
        .loading-dots div:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- é¡¶éƒ¨è®¾ç½®åŒºåŸŸ -->
    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-6xl mx-auto flex flex-col sm:flex-row items-center justify-between space-y-3 sm:space-y-0">
            <h1 class="text-2xl font-bold text-gray-800">LLMà½¢à½²à½‚à¼‹à½“à½´à½¦</h1>
            <button id="settingsBtn" class="bg-gray-100 text-gray-700 hover:bg-gray-200 font-medium py-2 px-4 rounded-lg transition duration-150 shadow-sm">
                âš™ï¸ API Key 
            </button>
        </div>
    </header>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">API Key ç®¡ç†</h2>
            <p class="text-sm text-red-600 mb-4">æ³¨æ„: Key ä»…å­˜å‚¨åœ¨æ‚¨çš„æµè§ˆå™¨ (localStorage) ä¸­ï¼Œä»¥ä¿æŠ¤éšç§ã€‚ä½†å‰ç«¯è°ƒç”¨å¯èƒ½å­˜åœ¨ CORS é™åˆ¶ã€‚</p>

            <label for="modelSelect" class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©è¦é…ç½®çš„æ¨¡å‹</label>
            <select id="modelSelect" class="w-full p-2 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
                <option value="gemini">Google Gemini 2.5 Pro (æ¨è)</option>
                <option value="chatgpt">OpenAI ChatGPT</option>
                <option value="claude">Anthropic Claude</option>
                <option value="grok">Grok</option>
                <option value="deepseek">DeepSeek</option>
            </select>

            <label for="apiKeyInput" class="block text-sm font-medium text-gray-700 mb-2">è¾“å…¥ API Key</label>
            <input type="password" id="apiKeyInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ Key" class="w-full p-3 border border-gray-300 rounded-lg mb-4 focus:ring-blue-500 focus:border-blue-500">
            
            <div class="flex justify-end space-x-3">
                <button id="saveKeyBtn" class="bg-blue-600 text-white font-medium py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">ä¿å­˜ Key</button>
                <button id="closeModalBtn" class="bg-gray-300 text-gray-800 font-medium py-2 px-4 rounded-lg hover:bg-gray-400 transition duration-150">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ä¸»èŠå¤©åŒºåŸŸ -->
    <!-- è°ƒæ•´ max-w-4xl åˆ° max-w-6xlï¼Œè®©èŠå¤©åŒºåŸŸæ›´å®½å¹¿ -->
    <main class="flex-grow w-full mx-auto p-4 flex flex-col max-w-6xl">
        <!-- å†å²è®°å½•/è¾“å‡ºåŒºåŸŸ -->
        <!-- ç§»é™¤ h-[70vh]ï¼Œä½¿ç”¨ flex-grow åŠ¨æ€å¡«å……ç©ºé—´ï¼Œå¹¶è®¾ç½® min-h ç¡®ä¿æ‰‹æœºç«¯å¯ç”¨ -->
        <div id="chatHistory" class="flex-grow bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-4 overflow-y-auto no-scrollbar min-h-[50vh]">
            <!-- èŠå¤©è®°å½•å°†åœ¨æ­¤å¤„åŠ¨æ€ç”Ÿæˆ -->
            <div class="text-center text-gray-500 py-8">
                "LLM à½¦à¾¡à½´à½‘à¼‹à½ à½‚à¾²à½²à½‚à¼‹à½‚à½‰à½ºà½¢à¼‹à½†à½¦à¼‹à½¦à¾¤à¾±à½¼à½‘à¼‹à½”à½¢à¼‹à½‘à½‚à½ à¼‹à½–à½¦à½´à¼‹à½à½´à¼ à½¦à¾’à½¼à¼‹à½–à¾±à½„à¼‹à½‚à½²à¼‹à½‚à½¡à½¦à¼‹à½Ÿà½´à½¢à¼‹à½‚à¾±à½²à¼‹ "API Key à½¦à¾’à¾²à½²à½‚à¼‹à½¦à¾Ÿà½„à½¦" à½à½ºà½¦à¼‹à½”à½¢à¼‹à½–à½¦à¾£à½´à½“à¼‹à½à½ºà¼‹à½à¾±à½ºà½‘à¼‹à½€à¾±à½²à¼‹ Key à½¦à¾’à¾²à½²à½‚à¼‹à½ à½‚à½¼à½‘à¼‹à½–à¾±à½ºà½‘à¼‹à½¢à¾—à½ºà½¦à¼ à½‚à¾³à½ºà½„à¼‹à½˜à½¼à¼‹à½ à½‚à½¼à¼‹à½ à½›à½´à½‚à½¦à¼‹à½‚à½“à½„à¼‹à½à½´à½–à¼"
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="bg-white p-4 rounded-xl shadow-lg border border-gray-200">
            <div class="flex items-center space-x-3 mb-3">
                <label for="modelSelector" class="text-sm font-medium text-gray-700 hidden sm:block">à½‘à½”à½ºà¼‹à½‚à½à½²à¼‹à½ à½‘à½ºà½˜à½¦à¼‹à½”à¼</label>
                <select id="modelSelector" class="flex-shrink-0 p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <option value="gemini">Gemini 2.5 Pro</option>
                    <option value="chatgpt">ChatGPT</option>
                    <option value="claude">Claude</option>
                    <option value="grok">Grok</option>
                    <option value="deepseek">DeepSeek</option>
                </select>
                <!-- API Key çŠ¶æ€æ˜¾ç¤ºï¼šç§»é™¤äº†é»˜è®¤çš„ "Gemini Key" æ–‡æœ¬ -->
                <div id="apiKeyStatus" class="flex-grow text-xs font-semibold text-red-500">
                </div>
            </div>
            <div class="flex space-x-3">
                <!-- å ä½ç¬¦å·²æ›´æ”¹ä¸ºè—æ–‡ -->
                <textarea id="userInput" class="flex-grow p-3 border border-gray-300 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3" placeholder="à½à¾±à½ºà½‘à¼‹à½€à¾±à½²à¼‹à½‘à¾²à½²à¼‹à½–à¼‹à½“à½„à¼‹à½ à½‡à½´à½‚à¼‹à½‚à½“à½„à¼‹à½¢à½¼à½‚à½¦à¼" onkeydown="handleKey(event)"></textarea>
                <button id="sendBtn" class="flex-shrink-0 bg-blue-600 text-white p-3 rounded-xl hover:bg-blue-700 transition duration-150 shadow-md flex items-center justify-center disabled:opacity-50" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6 transform rotate-90">
                        <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.547 60.547 0 0 0 18.44-8.895.75.75 0 0 0 0-1.218A60.547 60.547 0 0 0 3.478 2.405Z" />
                    </svg>
                </button>
            </div>
        </div>
    </main>

    <script>
        // å…¨å±€å˜é‡å’Œå…ƒç´ å¼•ç”¨
        const apiKeyMap = {}; // å­˜å‚¨ä¸åŒæ¨¡å‹çš„ API Key
        const models = ['gemini', 'chatgpt', 'claude', 'grok', 'deepseek'];
        let chatHistoryData = []; // åŸºç¡€å¯¹è¯å†å²è®°å½•
        let isGenerating = false; // é˜²æ­¢é‡å¤ç‚¹å‡»

        const elements = {
            settingsBtn: document.getElementById('settingsBtn'),
            settingsModal: document.getElementById('settingsModal'),
            modelSelect: document.getElementById('modelSelect'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            saveKeyBtn: document.getElementById('saveKeyBtn'),
            closeModalBtn: document.getElementById('closeModalBtn'),
            modelSelector: document.getElementById('modelSelector'),
            apiKeyStatus: document.getElementById('apiKeyStatus'),
            userInput: document.getElementById('userInput'),
            sendBtn: document.getElementById('sendBtn'),
            chatHistory: document.getElementById('chatHistory'),
        };

        // --- åˆå§‹åŒ–å’Œ Key ç®¡ç† ---

        /**
         * ä» localStorage åŠ è½½æ‰€æœ‰ API Key
         */
        function loadApiKeys() {
            models.forEach(model => {
                const key = localStorage.getItem(`llm_key_${model}`);
                if (key) {
                    apiKeyMap[model] = key;
                }
            });
            updateApiKeyStatus();
        }

        /**
         * æ›´æ–° Key çŠ¶æ€æ˜¾ç¤ºå’Œå‘é€æŒ‰é’®çŠ¶æ€
         */
        function updateApiKeyStatus() {
            const selectedModel = elements.modelSelector.value;
            const hasKey = !!apiKeyMap[selectedModel];
            
            if (hasKey) {
                // ç®€æ´é…ç½®æˆåŠŸçš„æç¤º
                elements.apiKeyStatus.textContent = `${selectedModel} Key å·²é…ç½®`; 
                elements.apiKeyStatus.className = 'flex-grow text-xs font-semibold text-green-600';
                elements.sendBtn.disabled = false;
            } else {
                // ç®€æ´é…ç½®ç¼ºå¤±çš„æç¤º (å·²ç§»é™¤â€œç¼ºå¤±â€äºŒå­—)
                elements.apiKeyStatus.textContent = `ğŸš¨ ${selectedModel} Key`; 
                elements.apiKeyStatus.className = 'flex-grow text-xs font-semibold text-red-500';
                elements.sendBtn.disabled = true;
            }

            // é’ˆå¯¹è®¾ç½®æ¨¡æ€æ¡†ï¼ŒåŒæ­¥æ˜¾ç¤ºå½“å‰é€‰æ‹©çš„ Key
            const currentModalModel = elements.modelSelect.value;
            elements.apiKeyInput.value = apiKeyMap[currentModalModel] || '';
        }

        // --- æ¨¡æ€æ¡†äº‹ä»¶å¤„ç† ---

        elements.settingsBtn.onclick = () => {
            elements.settingsModal.classList.remove('hidden');
            elements.settingsModal.classList.add('flex');
            // ç¡®ä¿æ¨¡æ€æ¡†æ‰“å¼€æ—¶ï¼Œè¾“å…¥æ¡†æ˜¾ç¤ºå½“å‰é€‰æ‹©æ¨¡å‹çš„ Key
            elements.modelSelect.value = elements.modelSelector.value;
            elements.apiKeyInput.value = apiKeyMap[elements.modelSelect.value] || '';
        };

        elements.closeModalBtn.onclick = () => {
            elements.settingsModal.classList.add('hidden');
            elements.settingsModal.classList.remove('flex');
        };

        elements.modelSelect.onchange = () => {
            // åˆ‡æ¢æ¨¡å‹æ—¶ï¼Œæ›´æ–°è¾“å…¥æ¡†å†…å®¹
            const selectedModel = elements.modelSelect.value;
            elements.apiKeyInput.value = apiKeyMap[selectedModel] || '';
        };

        elements.saveKeyBtn.onclick = () => {
            const model = elements.modelSelect.value;
            const key = elements.apiKeyInput.value.trim();

            if (key) {
                localStorage.setItem(`llm_key_${model}`, key);
                apiKeyMap[model] = key;
                alert(`æˆåŠŸä¿å­˜ ${model} çš„ API Key!`);
            } else {
                localStorage.removeItem(`llm_key_${model}`);
                delete apiKeyMap[model];
                alert(`å·²æ¸…é™¤ ${model} çš„ API Key.`);
            }
            
            elements.settingsModal.classList.add('hidden');
            elements.settingsModal.classList.remove('flex');
            updateApiKeyStatus();
        };

        // ç›‘å¬ä¸»é€‰æ‹©å™¨åˆ‡æ¢
        elements.modelSelector.onchange = updateApiKeyStatus;


        // --- UI æ¸²æŸ“å‡½æ•° ---

        /**
         * æ¸²æŸ“æ–°çš„èŠå¤©æ¶ˆæ¯åˆ°ç•Œé¢
         * @param {string} role 'user' æˆ– 'model'
         * @param {string} content æ¶ˆæ¯å†…å®¹
         * @param {string} modelName ä½¿ç”¨çš„æ¨¡å‹åç§°
         */
        function renderMessage(role, content, modelName = '') {
            // å¦‚æœå†å²åŒºåŸŸåªæœ‰æ¬¢è¿ä¿¡æ¯ï¼Œåˆ™æ¸…é™¤
            if (elements.chatHistory.firstElementChild && elements.chatHistory.firstElementChild.classList.contains('text-center')) {
                elements.chatHistory.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            const roleText = role === 'user' ? 'æ‚¨' : (modelName ? modelName : 'æ¨¡å‹');
            const bgColor = role === 'user' ? 'bg-blue-100' : 'bg-gray-50';
            const alignment = role === 'user' ? 'self-end' : 'self-start';
            const textColor = role === 'user' ? 'text-gray-800' : 'text-gray-700';
            const padding = 'p-3 rounded-xl max-w-[90%] sm:max-w-[75%] shadow-md whitespace-pre-wrap';

            messageDiv.className = `flex flex-col mb-4 ${alignment}`;
            messageDiv.innerHTML = `
                <div class="text-xs font-medium text-gray-500 mb-1">${roleText}</div>
                <div class="${bgColor} ${textColor} ${padding}">${content}</div>
            `;
            elements.chatHistory.appendChild(messageDiv);
            elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨
            return messageDiv.querySelector('div:last-child'); // è¿”å›å†…å®¹å—
        }

        /**
         * æ¸²æŸ“åŠ è½½æŒ‡ç¤ºå™¨
         * @param {string} modelName 
         */
        function renderLoadingIndicator(modelName) {
            // æ¸…é™¤æ¬¢è¿ä¿¡æ¯
            if (elements.chatHistory.firstElementChild && elements.chatHistory.firstElementChild.classList.contains('text-center')) {
                elements.chatHistory.innerHTML = '';
            }

            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingIndicator';
            loadingDiv.className = 'flex flex-col mb-4 self-start';
            loadingDiv.innerHTML = `
                <div class="text-xs font-medium text-gray-500 mb-1">${modelName} (åŠ è½½ä¸­...)</div>
                <div class="bg-gray-100 p-3 rounded-xl shadow-md max-w-[90%] sm:max-w-[75%]">
                    <div class="loading-dots flex">
                        <div></div><div></div><div></div>
                    </div>
                </div>
            `;
            elements.chatHistory.appendChild(loadingDiv);
            elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight;
        }

        /**
         * ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨å¹¶ç”¨æœ€ç»ˆç»“æœæ›¿æ¢
         * @param {string} finalContent 
         * @param {string} modelName 
         */
        function removeLoadingIndicator(finalContent, modelName) {
            const loadingDiv = document.getElementById('loadingIndicator');
            if (loadingDiv) {
                loadingDiv.innerHTML = `
                    <div class="text-xs font-medium text-gray-500 mb-1">${modelName}</div>
                    <div class="bg-gray-50 text-gray-700 p-3 rounded-xl shadow-md max-w-[90%] sm:max-w-[75%] whitespace-pre-wrap">${finalContent}</div>
                `;
                loadingDiv.id = ''; // æ¸…é™¤ ID
            }
            elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight;
        }

        // --- æ ¸å¿ƒ API è°ƒç”¨é€»è¾‘ ---

        /**
         * å¸¦æœ‰æŒ‡æ•°é€€é¿çš„ Fetch
         */
        async function fetchWithRetry(url, options, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                         // å¯¹äº 4xx/5xx é”™è¯¯ï¼ŒæŠ›å‡ºé”™è¯¯ä½†å…è®¸é‡è¯•ï¼ˆå¯é€‰ï¼Œå–å†³äºæ¨¡å‹ API çš„å…·ä½“è¡Œä¸ºï¼‰
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // æŒ‡æ•°é€€é¿
                    } else {
                        throw error;
                    }
                }
            }
        }

        /**
         * è°ƒç”¨é€‰å®šçš„å¤§è¯­è¨€æ¨¡å‹ API
         * @param {string} modelType - æ¨¡å‹ç±»å‹ (e.g., 'gemini', 'chatgpt')
         * @param {string} prompt - ç”¨æˆ·è¾“å…¥
         * @returns {Promise<string>} - æ¨¡å‹è¿”å›çš„æ–‡æœ¬å†…å®¹
         */
        async function callAPI(modelType, prompt) {
            const apiKey = apiKeyMap[modelType];
            let apiUrl = '';
            let payload = {};
            let responseText = '';
            
            if (!apiKey) {
                throw new Error(`è¯·å…ˆä¸º ${modelType} é…ç½® API Keyã€‚`);
            }

            // ç»Ÿä¸€çš„å†å²å¯¹è¯æ ¼å¼ (ä»…åŒ…å«ç”¨æˆ·æœ€æ–°çš„æç¤º)
            const conversation = [
                ...chatHistoryData.filter(m => m.model === modelType).slice(-5), // ä»…ä¿ç•™æœ€å 5 è½®å†å²
                { role: "user", parts: [{ text: prompt }] }
            ];

            // --- Gemini API (ä½¿ç”¨æ¨èçš„ gemini-2.5-flash-preview-05-20) ---
            if (modelType === 'gemini') {
                // æ³¨æ„: åœ¨ Canvas ç¯å¢ƒä¸­ï¼Œå¦‚æœ apiKey ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ³¨å…¥ã€‚
                // åœ¨ Github Pages ä¸Šï¼Œæ‚¨éœ€è¦ç¡®ä¿ Key å­˜åœ¨ã€‚
                apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                // å°†å†å²è®°å½•è½¬æ¢ä¸º Gemini æ ¼å¼
                const geminiContents = conversation.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: msg.parts
                }));

                payload = {
                    contents: geminiContents,
                };
            } 
            
            // --- Placeholder/Proxy Required APIs ---
            else if (modelType === 'chatgpt') {
                // WARNING: çº¯å‰ç«¯è°ƒç”¨ä¼šè§¦å‘ CORS é”™è¯¯ï¼Œå¹¶ä¸”æš´éœ²æ‚¨çš„ Keyã€‚
                // ç”Ÿäº§ç¯å¢ƒåº”é€šè¿‡æ‚¨è‡ªå»ºçš„åç«¯/ä»£ç†è½¬å‘ API Keyã€‚
                apiUrl = "https://api.openai.com/v1/chat/completions"; 
                
                // è½¬æ¢ä¸º ChatGPT æ¶ˆæ¯æ ¼å¼
                const gptMessages = conversation.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'assistant',
                    content: msg.parts[0].text
                }));

                payload = {
                    model: "gpt-4o-mini", // æ¨èä½¿ç”¨é«˜æ•ˆæ¨¡å‹
                    messages: gptMessages,
                };

                // ç”±äº CORSï¼Œæˆ‘ä»¬åœ¨æ­¤æ¨¡æ‹Ÿä¸€ä¸ªç»“æœï¼Œè€Œä¸æ˜¯å®é™…è°ƒç”¨
                // æ‚¨éœ€è¦ç¡®ä¿æ‚¨çš„ GitHub Pages URL è¢« OpenAI å…è®¸ (é€šå¸¸ä¸å¯èƒ½)
                console.warn("âš ï¸ æ­£åœ¨å°è¯•è°ƒç”¨ ChatGPT APIã€‚å¦‚æœå‘ç”Ÿ CORS é”™è¯¯ï¼Œè¯·åœ¨åç«¯è®¾ç½®ä»£ç†ã€‚");
                await new Promise(r => setTimeout(r, 1500)); // æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ
                responseText = `[${modelType} æ¨¡æ‹Ÿå“åº”] ç”±äº CORS é™åˆ¶ï¼Œå‰ç«¯ç›´æ¥è°ƒç”¨ ${modelType} å¤±è´¥æˆ–è¢«é˜»æ­¢ã€‚æ‚¨å‘é€äº†ï¼š"${prompt}"ã€‚è¯·éƒ¨ç½²åç«¯ä»£ç†ã€‚`;
                return responseText;
            }

            else if (modelType === 'claude') {
                // WARNING: çº¯å‰ç«¯è°ƒç”¨ä¼šè§¦å‘ CORS é”™è¯¯ã€‚
                apiUrl = "https://api.anthropic.com/v1/messages"; 
                
                // è½¬æ¢ä¸º Claude æ¶ˆæ¯æ ¼å¼
                const claudeMessages = conversation.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'assistant',
                    content: msg.parts[0].text
                }));

                payload = {
                    model: "claude-3-haiku-20240307",
                    max_tokens: 1024,
                    messages: claudeMessages,
                };

                // æ¨¡æ‹Ÿç»“æœ
                console.warn("âš ï¸ æ­£åœ¨å°è¯•è°ƒç”¨ Claude APIã€‚å¦‚æœå‘ç”Ÿ CORS é”™è¯¯ï¼Œè¯·åœ¨åç«¯è®¾ç½®ä»£ç†ã€‚");
                await new Promise(r => setTimeout(r, 1500));
                responseText = `[${modelType} æ¨¡æ‹Ÿå“åº”] ç”±äº CORS é™åˆ¶ï¼Œå‰ç«¯ç›´æ¥è°ƒç”¨ ${modelType} å¤±è´¥æˆ–è¢«é˜»æ­¢ã€‚æ‚¨å‘é€äº†ï¼š"${prompt}"ã€‚è¯·éƒ¨ç½²åç«¯ä»£ç†ã€‚`;
                return responseText;
            }

            else if (modelType === 'grok' || modelType === 'deepseek') {
                // Grok å’Œ DeepSeek ä¹Ÿéœ€è¦åç«¯ä»£ç†
                console.warn(`âš ï¸ æ­£åœ¨å°è¯•è°ƒç”¨ ${modelType} APIã€‚é€šå¸¸éœ€è¦åç«¯ä»£ç†ã€‚`);
                await new Promise(r => setTimeout(r, 1500));
                responseText = `[${modelType} æ¨¡æ‹Ÿå“åº”] ç”±äº ${modelType} API çš„å®‰å…¨å’Œ CORS é™åˆ¶ï¼Œæ‚¨å‡ ä¹è‚¯å®šéœ€è¦ä¸€ä¸ªåç«¯ä»£ç†æœåŠ¡å™¨æ¥å¤„ç†æ­¤è¯·æ±‚ã€‚æ‚¨å‘é€äº†ï¼š"${prompt}"ã€‚`;
                return responseText;
            }
            // --- End Placeholder/Proxy Required APIs ---
            
            
            // --- å®é™… Fetch é€»è¾‘ (ä¸»è¦é’ˆå¯¹ Gemini) ---
            if (modelType === 'gemini') {
                const fetchOptions = {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                };

                try {
                    const response = await fetchWithRetry(apiUrl, fetchOptions);
                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0) {
                        responseText = result.candidates[0].content.parts[0].text || "æ¨¡å‹è¿”å›å†…å®¹ä¸ºç©ºã€‚";
                    } else if (result.error) {
                         responseText = `API é”™è¯¯: ${result.error.message}`;
                    } else {
                         responseText = "æœªçŸ¥ API é”™è¯¯ã€‚è¯·æ£€æŸ¥æ§åˆ¶å°ã€‚";
                    }
                } catch (error) {
                    responseText = `ç½‘ç»œæˆ– API è°ƒç”¨å¤±è´¥: ${error.message}. è¯·æ£€æŸ¥æ‚¨çš„ Key æˆ– CORS è®¾ç½®ã€‚`;
                }
            }


            // æ›´æ–°èŠå¤©å†å²ï¼Œåªæœ‰åœ¨éæ¨¡æ‹Ÿæƒ…å†µä¸‹æ‰æ›´æ–°
            if (!responseText.includes("[æ¨¡æ‹Ÿå“åº”]")) {
                chatHistoryData.push({ 
                    role: 'model', 
                    model: modelType,
                    parts: [{ text: responseText }] 
                });
            }

            return responseText;
        }


        // --- ä¸»å‘é€æµç¨‹ ---

        async function handleSend() {
            if (isGenerating) return;

            const prompt = elements.userInput.value.trim();
            if (!prompt) return;

            const selectedModel = elements.modelSelector.value;
            const apiKey = apiKeyMap[selectedModel];

            if (!apiKey) {
                alert(`è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® ${selectedModel} çš„ API Key.`);
                return;
            }

            elements.userInput.value = '';
            isGenerating = true;
            elements.sendBtn.disabled = true;

            // 1. æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯å¹¶æ·»åŠ åˆ°å†å²
            renderMessage('user', prompt);
            chatHistoryData.push({ 
                role: 'user', 
                model: selectedModel,
                parts: [{ text: prompt }] 
            });

            // 2. æ¸²æŸ“åŠ è½½æŒ‡ç¤ºå™¨
            renderLoadingIndicator(selectedModel);

            let modelResponse = '';
            try {
                // 3. è°ƒç”¨ API
                modelResponse = await callAPI(selectedModel, prompt);
            } catch (error) {
                console.error("API è°ƒç”¨å¤±è´¥:", error);
                modelResponse = `æ“ä½œå¤±è´¥: ${error.message}`;
            } finally {
                // 4. ç§»é™¤åŠ è½½å¹¶æ˜¾ç¤ºç»“æœ
                removeLoadingIndicator(modelResponse, selectedModel);
                isGenerating = false;
                elements.sendBtn.disabled = false;
            }
        }

        // ç»‘å®šäº‹ä»¶
        elements.sendBtn.addEventListener('click', handleSend);
        function handleKey(event) {
            // æ‰‹æœºç«¯é€šå¸¸ä¸ä½¿ç”¨ Ctrl+Enterï¼Œåªç›‘å¬ Enter
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleSend();
            }
        }

        // --- é¡µé¢åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKeys();
        });

    </script>
</body>
</html>
